# 分离 build 和 release 的触发条件
name: Go Build and Release

on:
  # 统一使用一个 push 事件：main 分支普通提交 或 v*.*.* 标签推送
  push:
    branches:
      - main
    tags:
      - 'v*'

  # 手动触发（可选择运行任一 job）
  workflow_dispatch:

jobs:
  build:
    # 仅 main 分支 push 且非 tag push 时运行
    if: github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 拉取完整的 Git 历史记录
          fetch-tags: true # 确保拉取所有标签（正确字段）
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.25.3
      - name: Install dependencies
        run: |
          go version
          go mod tidy
      - name: Build Windows Executable
        run: |
          git log -1 > commit_log.txt
          $version = $(git describe --tags --match "v[0-9]*" --always)
          $buildDate = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
          $gitHash = $(git rev-parse --short HEAD)
          $ldflags = "-H=windowsgui -s -w -X main.version=$version -X main.buildDate=$buildDate -X main.gitHash=$gitHash"
          Write-Host "Building ldflags: $ldflags"
          go build -ldflags "$ldflags" -o KKCardModCheck.exe -trimpath
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: KKCardModCheck.exe
          path: ./KKCardModCheck.exe

  release:
    runs-on: windows-latest
    # 仅在 v*.*.* tag push 时运行
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write # 需要写权限来创建 Release
    steps:
      - id: build_changelog
        name: Build Changelog File
        uses: mikepenz/release-changelog-builder-action@v5
        with:
          configuration: .github/release-changelog-builder-config.json
          toTag: ${{ github.ref_name }}
          mode: COMMIT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 把 action 的输出写入到 CHANGELOG.md 文件并打印（在 Windows runner 上使用 PowerShell）
      - name: Save and Show Changelog (PowerShell)
        env:
          CHANGELOG: ${{ steps.build_changelog.outputs.changelog }}
        run: |
          # 将输出写入文件以便 later steps 可以上传
          Set-Content -Path CHANGELOG.md -Value $env:CHANGELOG -NoNewline
          Write-Host "CHANGELOG saved to CHANGELOG.md"
          Write-Host "---- BEGIN CHANGELOG ----"
          Write-Host $env:CHANGELOG
          Write-Host "----  END CHANGELOG  ----"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 拉取完整的 Git 历史记录
          fetch-tags: true # 确保拉取所有标签（正确字段）
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.25.3
      - name: Install dependencies
        run: |
          go version
          go mod tidy
      - name: Build Windows Executable
        run: |
          git log -1 > commit_log.txt
          $version = $(git describe --tags --match "v[0-9]*" --always)
          $buildDate = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
          $gitHash = $(git rev-parse --short HEAD)
          $ldflags = "-H=windowsgui -s -w -X main.version=$version -X main.buildDate=$buildDate -X main.gitHash=$gitHash"
          Write-Host "Building ldflags: $ldflags"
          go build -ldflags "$ldflags" -o KKCardModCheck.exe -trimpath
      - name: Create ZIP Archive
        run: |
          $tag = $env:GITHUB_REF -replace 'refs/tags/', ''
          $zip = "KKCardModCheck_$tag.zip"
          Compress-Archive -Path KKCardModCheck.exe -DestinationPath $zip -Force
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          body: ${{ steps.build_changelog.outputs.changelog }}
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-b') || contains(github.ref, '-a') }}
          files: |
            ./KKCardModCheck_*.zip
            ./CHANGELOG.md