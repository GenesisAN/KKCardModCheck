# ÂàÜÁ¶ª build Âíå release ÁöÑËß¶ÂèëÊù°‰ª∂
name: Go Build and Release

on:
  # Áªü‰∏Ä‰ΩøÁî®‰∏Ä‰∏™ push ‰∫ã‰ª∂Ôºömain ÂàÜÊîØÊôÆÈÄöÊèê‰∫§ Êàñ v*.*.* Ê†áÁ≠æÊé®ÈÄÅ
  push:
    branches:
      - main
    tags:
      - 'v*'

  # ÊâãÂä®Ëß¶ÂèëÔºàÂèØÈÄâÊã©ËøêË°å‰ªª‰∏Ä jobÔºâ
  workflow_dispatch:

jobs:
  build:
    # ‰ªÖ main ÂàÜÊîØ push ‰∏îÈùû tag push Êó∂ËøêË°å
    if: github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ÊãâÂèñÂÆåÊï¥ÁöÑ Git ÂéÜÂè≤ËÆ∞ÂΩï
          fetch-tags: true # Á°Æ‰øùÊãâÂèñÊâÄÊúâÊ†áÁ≠æÔºàÊ≠£Á°ÆÂ≠óÊÆµÔºâ
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.25.3
      - name: Install dependencies
        run: |
          go version
          go mod tidy
      - name: Build Windows Executable
        run: |
          git log -1 > commit_log.txt
          $version = $(git describe --tags --match "v[0-9]*" --always)
          $buildDate = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
          $gitHash = $(git rev-parse --short HEAD)
          $ldflags = "-H=windowsgui -s -w -X main.version=$version -X main.buildDate=$buildDate -X main.gitHash=$gitHash"
          Write-Host "Building ldflags: $ldflags"
          go build -ldflags "$ldflags" -o KKCardModCheck.exe -trimpath
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: KKCardModCheck.exe
          path: ./KKCardModCheck.exe

  release:
    runs-on: windows-latest
    # ‰ªÖÂú® v*.*.* tag push Êó∂ËøêË°å
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write # ÈúÄË¶ÅÂÜôÊùÉÈôêÊù•ÂàõÂª∫ Release
    steps:
      - id: build_changelog
        name: Build Changelog File
        uses: mikepenz/release-changelog-builder-action@v5
        with:
          toTag: ${{ github.ref_name }}
          mode: COMMIT
          configurationJson: |
            {
              "template": "#{{CHANGELOG}}\n\n<details>\n<summary>Uncategorized</summary>\n\n#{{UNCATEGORIZED}}\n</details>",
              "categories": [
              {
                "title": "## üöÄ Êñ∞ÂäüËÉΩ",
                "labels": ["feature", "feat", "enhancement", "Êñ∞ÂäüËÉΩ"]
              },
              {
                "title": "## üêõ ‰øÆÂ§ç",
                "labels": ["fix", "bugfix", "bug", "‰øÆÂ§ç"]
              },
              {
                "title": "## üîß ‰ºòÂåñ",
                "labels": ["improve", "improvement", "tweak", "‰ºòÂåñ", "Ë∞ÉÊï¥"]
              },
              {
                "title": "## üß™ ÊµãËØï",
                "labels": ["test", "tests", "testing", "ÊµãËØï"]
              },
              {
                "title": "## üìù ÊñáÊ°£",
                "labels": ["docs", "documentation", "ÊñáÊ°£"]
              },
              {
                "title": "## üé® Ê†∑Âºè",
                "labels": ["style", "formatting", "Ê†∑Âºè"]
              },
              {
                "title": "## ‚ôªÔ∏è ÈáçÊûÑ",
                "labels": ["refactor", "refactoring", "ÈáçÊûÑ"]
              },
              {
                "title": "## ‚ö° ÊÄßËÉΩ",
                "labels": ["perf", "performance", "optimization", "ÊÄßËÉΩ"]
              },
              {
                "title": "## üîß ÊùÇÈ°π",
                "labels": ["chore", "build", "ci", "ÊùÇÈ°π"]
              },
              {
                "title": "## üì¶ ‰æùËµñ",
                "labels": ["dependencies", "deps", "dependency", "‰æùËµñ"]
              }
              ]
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Êää action ÁöÑËæìÂá∫ÂÜôÂÖ•Âà∞ CHANGELOG.md Êñá‰ª∂Âπ∂ÊâìÂç∞ÔºàÂú® Windows runner ‰∏ä‰ΩøÁî® PowerShellÔºâ
      - name: Save and Show Changelog (PowerShell)
        env:
          CHANGELOG: ${{ steps.build_changelog.outputs.changelog }}
        run: |
          # Â∞ÜËæìÂá∫ÂÜôÂÖ•Êñá‰ª∂‰ª•‰æø later steps ÂèØ‰ª•‰∏ä‰º†
          Set-Content -Path CHANGELOG.md -Value $env:CHANGELOG -NoNewline
          Write-Host "CHANGELOG saved to CHANGELOG.md"
          Write-Host "---- BEGIN CHANGELOG ----"
          Write-Host $env:CHANGELOG
          Write-Host "----  END CHANGELOG  ----"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ÊãâÂèñÂÆåÊï¥ÁöÑ Git ÂéÜÂè≤ËÆ∞ÂΩï
          fetch-tags: true # Á°Æ‰øùÊãâÂèñÊâÄÊúâÊ†áÁ≠æÔºàÊ≠£Á°ÆÂ≠óÊÆµÔºâ
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.25.3
      - name: Install dependencies
        run: |
          go version
          go mod tidy
      - name: Build Windows Executable
        run: |
          git log -1 > commit_log.txt
          $version = $(git describe --tags --match "v[0-9]*" --always)
          $buildDate = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
          $gitHash = $(git rev-parse --short HEAD)
          $ldflags = "-H=windowsgui -s -w -X main.version=$version -X main.buildDate=$buildDate -X main.gitHash=$gitHash"
          Write-Host "Building ldflags: $ldflags"
          go build -ldflags "$ldflags" -o KKCardModCheck.exe -trimpath
      - name: Create ZIP Archive
        run: |
          $tag = $env:GITHUB_REF -replace 'refs/tags/', ''
          $zip = "KKCardModCheck_$tag.zip"
          Compress-Archive -Path KKCardModCheck.exe -DestinationPath $zip -Force
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          body: ${{ steps.build_changelog.outputs.changelog }}
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-b') || contains(github.ref, '-a') }}
          files: |
            ./KKCardModCheck_*.zip
            ./CHANGELOG.md